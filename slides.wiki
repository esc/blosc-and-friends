== Blosc  ==

==== Outline ====

\tableofcontents[currentsection]

==== Disclaimer ====

* All examples with Py3
* No comparisons to other technologies

==== Blosc ====

* '''Blocking''' by operating on data in blocks
* '''Shuffling''' by doing a byte shuffle
* '''Fast''' by multithreading across '''blocks'''
* '''Metacodec''' because it can drive '''[lz4|snappy|zlib]'''

==== Blosc ====

<[center]
<<<images/blosc.pdf, scale=0.3>>>
[center]>

==== Blosc ====

* Other codecs vendored

==  Python-Blosc ==

==== Python-Blosc ====

* '''Python-Blosc''' <-- python bindings
* Blosc (and codecs) are vendored
* Can be dynamically linked

==== Code, Yo! ====[containsverbatim]

<[nowiki]
\begin{pyconcode}
>>> import blosc
>>> b = b"b"*888
>>> c = blosc.compress(b, typesize=8)
>>> len(b)/len(c)
15.857142857142858
>>> c = blosc.compress(b, typesize=1, shuffle=False,
... clevel=9, cname='lz4')
>>> len(b)/len(c)
23.36842105263158
\end{pyconcode}
[nowiki]>

==== C'mmon man, your pulling my leg?! ==== [containsverbatim]

<[pyconcode]
>>> d = blosc.decompress(compressed)
>>> assert b == d
[pyconcode]>

==== What Up? ====

* Long sequence of the same character
* Not hard to beat
* Feel free to try with some input of your own choosing
* Feel free to compare to @zlib@

==== Help ====

* Version 1.2.7 (latest) not Windows compatible
* Doesn't yet support compressing via buffer-interface


==== Outline ====

\tableofcontents[currentsection]

== Bloscpack ==

==== And now some «stuff» layerd on top! ====

* '''Bloscpack'''
* Command-line interface
* File-format
* '''Numpy''' array serialization
* Pure-python based on Python-Blosc

==== More Code, Yo! ====[containsverbatim]

<[pyconcode]
>>> import bloscpack, numpy
>>> b = numpy.arange(5e6)
>>> c = bloscpack.pack_ndarray_str(b)
>>> len(b)/len(c)
15.359992135684026

>>> c = bloscpack.pack_ndarray_str(b,
... blosc_args=bloscpack.BloscArgs(clevel=9, cname='lz4'))
>>> len(b)/len(c)
17.693979092794304
[pyconcode]>

==== And Back Again ====[containsverbatim]

<[pyconcode]
>>> d = bloscpack.unpack_ndarray_str(c)
>>> assert (b == d).all()
[pyconcode]>

==== Command-line Usability ====[containsverbatim]

<[pyconcode]
>>> np.save('b.npy', b)
[pyconcode]>

<[consolecode]
$ ./blpk compress b.npy
$ ./blpk compress -l 9 -c lz4 b.npy b.npy.lv9lz4.blp
$ ls -lh b.*
-rw------- 1 esc esc  39M May 13 21:50 b.npy
-rw------- 1 esc esc 319K May 13 21:52 b.npy.blp
-rw------- 1 esc esc 277K May 17 20:39 b.npy.lv9lz4.blp
[consolecode]>


==== Format ====

* A '''simple''' file format
* Optional
** '''Checksum'''
** '''Metadata'''
** '''Offsets'''

<[center]
<<<images/bloscpack.pdf, scale=0.3>>>
[center]>

==== Numpy Support ====[containsverbatim]

* Python-Blosc can also pack an array:

<[pyconcode]
>>> b = numpy.arange(5e6)
>>> %timeit c = blosc.pack_array(b)
10 loops, best of 3: 40.2 ms per loop

>>> %timeit c = bloscpack.pack_ndarray_str(b)
100 loops, best of 3: 9.81 ms per loop
[pyconcode]>

* Internal copy vs. pointer operation
* Numpy metadata is stored in metadata section

--1cm--

<[pyconcode]
>>> from io import BytesIO
>>> %timeit bio=BytesIO(); np.save(bio, b)
...
[pyconcode]>

==== Help ====

* @pack\_ndarray\_'''str'''@ <-- '''str''', really?!
* Py3 support not merged :(


== Bcolz ==

==== Outline ====

\tableofcontents[currentsection,currentsubsection]

==== Bcolz ====

* Chunked container
* In-memory and out-of-core
* @CArray@ and @CTable@
* Good for '''medium data'''
* Support basic analytics
* Uses Blosc and Bloscpack under the hood
* Python/Cython

==== Layout of the @CArray@ ====

<[columns]
[[[5cm]]]
<[center]
<<<images/bcolz.pdf, scale=0.3>>>
[center]>
[[[5cm]]]
* Discontigous
* Blosc-compressed
* Homogeneously typed
* '''chunks'''
[columns]>

==== Creating a @CArray@ ====[containsverbatim]

<[pyconcode]
>>> b = bcolz.arange(5e6)
>>> b
carray((5000000,), float64)
  nbytes: 38.15 MB; cbytes: 1.45 MB; ratio: 26.33
  cparams := cparams(clevel=5, shuffle=True, cname='blosclz')
[  0.00000000e+00   1.00000000e+00   2.00000000e+00 ...,   4.99999700e+06
   4.99999800e+06   4.99999900e+06]
[pyconcode]>

==== Variation ====[containsverbatim]

<[pyconcode]
>>> b = bcolz.arange(5e6, cparams=bcolz.cparams(clevel=9, cname='lz4'))

>>> b
carray((5000000,), float64)
  nbytes: 38.15 MB; cbytes: 849.54 KB; ratio: 45.98
  cparams := cparams(clevel=9, shuffle=True, cname='lz4')
[  0.00000000e+00   1.00000000e+00   2.00000000e+00 ...,   4.99999700e+06
   4.99999800e+06   4.99999900e+06]
[pyconcode]>

==== On-Disk ====[containsverbatim]

<[nowiki]
\begin{pyconcode}
>>> b = bcolz.arange(5e6, rootdir='bexample', chunklen=1000**2)
>>> ls -lah bexample/*
-rw------- 1 esc esc    3 May 17 22:19 bexample/__attrs__

bexample/data:
total 992K
drwx------ 2 esc esc 4.0K May 17 22:19 ./
drwx------ 4 esc esc 4.0K May 17 22:19 ../
-rw------- 1 esc esc 168K May 17 22:19 __0.blp
-rw------- 1 esc esc 138K May 17 22:19 __1.blp
-rw------- 1 esc esc 190K May 17 22:19 __2.blp
-rw------- 1 esc esc 195K May 17 22:19 __3.blp
-rw------- 1 esc esc 286K May 17 22:19 __4.blp

bexample/meta:
total 16K
drwx------ 2 esc esc 4.0K May 17 22:19 ./
drwx------ 4 esc esc 4.0K May 17 22:19 ../
-rw------- 1 esc esc   60 May 17 22:19 sizes
-rw------- 1 esc esc  122 May 17 22:19 storage
\end{pyconcode}
[nowiki]>


==== Layout of the @CTable@ ====

<[columns]
[[[5cm]]]
<[center]
<<<images/bcolz-ctable.pdf, scale=0.3>>>
[center]>
[[[5cm]]]
* Columnar
* Heterogeneously typed
* Every column --> @CArray@
[columns]>

==== Summary (I) ====

* Everyone always asks me about the relationship of our toolstack

==== Summary (II) ====

* '''Blosc'''
** The codec
* '''Python-Blosc'''
** The Python bindings
* '''Bloscpack'''
** Serialization format
** Command-line interface
** Fast Numpy serializer
* '''Bcolz'''
** Compressed container(s)
** In-memory and out-of-core
** Analytics engine

==== Summary (III) ====

* '''Bcolz''' uses a vendored, older version of Bloscpack
* '''Bcolz''' interfaces with Blosc using it's own Cython bindings

==== Slide 42 ====

* Open source tools used to make this presentation:
** \href{http://wiki2beamer.sourceforge.net/}{Wiki2beamer}
** \href{http://latex-beamer.sourceforge.net/}{\LaTeX beamer}
** \href{http://projects.gnome.org/dia/}{Dia}
** \href{http://pygments.org/}{Pygments}
** \href{http://code.google.com/p/minted/}{Minted}
** \href{https://bitbucket.org/john2x/solarized-pygment}{Solarized theme for pygments}
